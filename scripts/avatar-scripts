#!/bin/bash
# AVATAR Scripts - 主控制腳本
# Linus 式簡潔設計：一個命令管理所有腳本

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 顏色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}=========================================="
    echo -e "  AVATAR Scripts Manager"
    echo -e "==========================================${NC}"
    echo ""
}

print_category() {
    echo -e "${GREEN}[$1]${NC}"
    echo ""
}

show_help() {
    print_header

    print_category "SETUP - 初始環境設置"
    echo "  setup-env      下載模型並驗證環境"
    echo "  setup-db       初始化資料庫"
    echo "  setup-cuda     設置 CUDA (WSL2)"
    echo ""

    print_category "MAINTENANCE - 系統維護"
    echo "  cleanup        智能快取清理"
    echo "  cleanup-quick  快速清理"
    echo "  cleanup-deep   深度資源清理"
    echo ""

    print_category "TESTING - 測試與驗證"
    echo "  test-models    測試 AI 模型載入"
    echo "  test-audio     生成測試音檔"
    echo "  test-hq-tts    測試 HQ TTS 質量對比"
    echo "  test-all       執行完整測試套件"
    echo ""

    print_category "DEVELOPMENT - 開發工具"
    echo "  dev-validate   驗證開發環境"
    echo ""

    echo -e "${YELLOW}Usage:${NC}"
    echo "  ./scripts/avatar-scripts [command]"
    echo "  poetry run python -m scripts.avatar-scripts [command]"
    echo ""
}

run_script() {
    local category=$1
    local script=$2
    local description=$3

    echo -e "${GREEN}[RUN]${NC} $description"
    echo ""

    if [[ -f "$SCRIPT_DIR/$category/$script" ]]; then
        if [[ "$script" == *.py ]]; then
            poetry run python "$SCRIPT_DIR/$category/$script"
        else
            bash "$SCRIPT_DIR/$category/$script"
        fi
    else
        echo -e "${RED}[ERROR]${NC} Script not found: $SCRIPT_DIR/$category/$script"
        exit 1
    fi
}

# 主邏輯
case "${1:-help}" in
    # Setup commands
    "setup-env")
        run_script "setup" "download_models.py" "下載 AI 模型並驗證環境"
        ;;
    "setup-db")
        run_script "setup" "init_database.py" "初始化 SQLite 資料庫"
        ;;
    "setup-cuda")
        run_script "setup" "setup_cuda_wsl2.sh" "設置 CUDA Toolkit (WSL2)"
        ;;

    # Maintenance commands
    "cleanup")
        run_script "maintenance" "cleanup_cache.sh" "智能快取清理"
        ;;
    "cleanup-quick")
        run_script "maintenance" "quick_cleanup.sh" "快速清理"
        ;;
    "cleanup-deep")
        run_script "maintenance" "linux_resource_cleanup.sh" "深度資源清理"
        ;;

    # Testing commands
    "test-models")
        run_script "testing" "test_model_loading.py" "測試 AI 模型載入與 VRAM"
        ;;
    "test-audio")
        run_script "testing" "generate_test_audio.py" "生成測試音檔"
        ;;
    "test-hq-tts")
        echo -e "${GREEN}[RUN]${NC} 測試 HQ TTS 質量對比"
        echo ""
        PYTHONPATH="$SCRIPT_DIR/../src:$PYTHONPATH" poetry run python "$SCRIPT_DIR/../tests/e2e_hq_tts_test.py"
        ;;
    "test-all")
        run_script "testing" "run_tests.sh" "執行完整測試套件"
        ;;

    # Development commands
    "dev-validate")
        run_script "setup" "validate_setup.py" "驗證開發環境設置"
        ;;

    # Help
    "help"|"-h"|"--help"|*)
        show_help
        ;;
esac